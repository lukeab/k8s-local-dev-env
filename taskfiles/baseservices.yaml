# https://taskfile.dev

version: '3'
tasks:
  create_app_cert_manager: 
    cmds: 
      - argocd app create --upsert cert-manager -f argocd/base-services/cert-manager/cert-manager-app.yaml
      - argocd app wait cert-manager --sync
      - task: :Util:wait_for_deployments
        vars:
          NAMESPACE: cert-manager
      - argocd app create --upsert cert-manager-default-clusterissuer -f argocd/base-services/cert-manager/default-clusterissuer-app.yaml --validate=false --sync-policy none 
      - argocd app sync cert-manager-default-clusterissuer --local argo-k3d-deployments/cert-manager-default-clusterissuer --local-repo-root argo-k3d-deployments

  create_app_prometheus_stack:
    cmds:
      - argocd app create --upsert kube-prometheus-stack -f argocd/base-services/prometheus-stack/prometheus-stack.yaml
      - argocd app wait kube-prometheus-stack --sync
      - task: :Util:wait_for_deployments
        vars:
          NAMESPACE: prometheus

  create_CA_cert:
    cmds:
      - |
        echo "##!! Setting up ca certificate for local development and registering it in your current development cluster context"
        echo 
        echo "##!! WARNING: This will install a CA certificate in ${OS_CERT_PATH} and update your certificates trust in your operating system and chrome/chromium!"
        echo 
        [ ! -f "data/ca.key" ] && openssl genrsa -out "data/ca.key" 4096
        [ ! -f "data/ca.crt" ] && openssl req -new -x509 -sha256 --config "helm/cert-manager/config.cnf" -days 10950 -key "data/ca.key" -out "data/ca.crt"
        B64_KEY="$(base64 -w 0 "data/ca.key")"
        B64_CRT="$(base64 -w 0 "data/ca.crt")"
        export B64_KEY B64_CRT
        envsubst < "helm/cert-manager/secret-ca.yaml.tpl" > "data/secret-ca.yaml"
        ## copy secret to argocd deployments directory
        cp "data/secret-ca.yaml" argo-k3d-deployments/cert-manager-default-clusterissuer/
        if [ ! -f "${OS_CERT_PATH}" ]; then
          sudo cp "data/ca.crt" "${OS_CERT_PATH}"
          sudo {{.UPDATE_CA_TRUST_CMD}}
        else
          echo "${OS_CERT_PATH} already setup - skipping cp and {{.UPDATE_CA_TRUST_CMD}}"
        fi
        certutil -d sql:$HOME/.pki/nssdb -A -t "CT,c,c" -n cert-manager-local-dev-ca -i "data/ca.crt"
        certutil -L -d sql:$HOME/.pki/nssdb
        certutil -d sql:$HOME/.pki/nssdb -L -n cert-manager-local-dev-ca
      